<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EggMonitor AI Dashboard (Single File)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { font-family: 'Inter', sans-serif; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
    <!-- Import Maps for ES Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
        "@google/genai": "https://esm.sh/@google/genai@0.1.1"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend, ComposedChart, Area
        } from 'recharts';
        import { 
            Activity, BarChart2, TrendingUp, FileText, MessageSquare, Menu, Calendar, Upload, Download, Loader, Egg, PieChart, ZoomIn,
            X, CheckCircle, ArrowUpRight, ArrowDownRight, Send
        } from 'lucide-react';
        import { GoogleGenAI } from '@google/genai';

        // --- Mock Data Utils ---
        const generateMockData = () => {
            const farms = ['Granja Sol', 'Granja Luna', 'Granja Estrella'];
            const sheds = ['A1', 'A2', 'B1', 'B2'];
            const ages = ['30', '45', '60', '75'];
            const breeds = ['Hy-Line', 'Lohmann', 'Shaver']; 
            const data = [];
            const endDate = new Date();

            for (let i = 180; i >= 0; i--) { 
                for (const farm of farms) {
                    const date = new Date();
                    date.setDate(endDate.getDate() - i);
                    data.push({
                        date: date.toISOString().split('T')[0],
                        farm: farm, 
                        shed: sheds[Math.floor(Math.random() * sheds.length)], 
                        age: ages[Math.floor(Math.random() * ages.length)],
                        breed: breeds[Math.floor(Math.random() * breeds.length)],
                        weight: 58 + Math.random() * 10 - 5, 
                        breakingStrength: 3.5 + Math.random() * 1.5 - 0.75,
                        shellThickness: 0.35 + Math.random() * 0.1 - 0.05, 
                        yolkColor: 9 + Math.random() * 4 - 2,
                        haughUnits: 75 + Math.random() * 20 - 10,
                    });
                }
            }
            return data.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
        };

        const calculateAllStats = (data, key) => {
            const values = data.map(d => d[key]).filter(v => typeof v === 'number' && !isNaN(v));
            if (values.length === 0) return { mean: 0, std: 0, min: 0, max: 0 };
            const sum = values.reduce((acc, val) => acc + val, 0);
            const mean = sum / values.length;
            const sqDiffs = values.map(val => Math.pow(val - mean, 2));
            const avgSqDiff = sqDiffs.reduce((acc, val) => acc + val, 0) / values.length;
            const std = Math.sqrt(avgSqDiff);
            return { mean, std, min: Math.min(...values), max: Math.max(...values) };
        };

        const getHistogramData = (data, key, bins = 12) => {
            const values = data.map(d => d[key]).filter(v => typeof v === 'number' && !isNaN(v));
            if (values.length === 0) return [];
            const min = Math.min(...values); 
            const max = Math.max(...values);
            if (min === max) return [{ range: `${min.toFixed(2)}`, rangeLabel: `${min.toFixed(2)}`, count: values.length }];
            const binWidth = (max - min) / bins;
            const histogram = Array.from({ length: bins }, (_, i) => ({ 
                range: `${(min + i * binWidth).toFixed(1)}`,
                rangeLabel: `${(min + i * binWidth).toFixed(2)} - ${(min + (i + 1) * binWidth).toFixed(2)}`,
                count: 0 
            }));
            values.forEach(value => {
                let binIndex = Math.floor((value - min) / binWidth);
                if (binIndex === bins) binIndex--;
                if (histogram[binIndex]) histogram[binIndex].count++;
            });
            return histogram;
        };

        // --- Gemini Service ---
        // NOTE: process.env.API_KEY needs to be supplied here for the HTML file to work standalone.
        // REPLACE 'YOUR_API_KEY_HERE' WITH YOUR ACTUAL KEY IF RUNNING LOCALLY
        const API_KEY = process.env.API_KEY || 'YOUR_API_KEY_HERE';
        const ai = new GoogleGenAI({ apiKey: API_KEY });

        const sendMessageToGemini = async (userQuery, dataContext) => {
            try {
                if (API_KEY === 'YOUR_API_KEY_HERE') {
                    return { text: "Error: No se ha configurado la API KEY en el archivo HTML.", sources: [] };
                }
                const fullPrompt = `Basándote en el siguiente contexto de datos, responde mi pregunta.
                --- CONTEXTO DE DATOS ACTUAL ---
                ${dataContext}
                --- FIN CONTEXTO ---
                Mi pregunta es: ${userQuery}`;

                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: fullPrompt,
                    config: {
                        systemInstruction: "Eres un experto en avicultura y análisis de calidad de huevo (Egg Quality Monitor). Tu tarea es interpretar los datos estadísticos proporcionados, responder la pregunta del usuario con claridad y utilizando un tono profesional y accesible (en español).",
                        tools: [{ googleSearch: {} }],
                    }
                });

                const text = response.text || "No pude generar una respuesta.";
                let sources = [];
                const groundingChunks = response.candidates?.[0]?.groundingMetadata?.groundingChunks;
                if (groundingChunks) {
                    sources = groundingChunks.filter(c => c.web?.uri && c.web?.title).map(c => ({ uri: c.web.uri, title: c.web.title }));
                }
                return { text, sources };
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw new Error("Error al comunicarse con el asistente.");
            }
        };

        // --- UI Components ---
        const EggMonitorLogo = ({ size = 40 }) => (
            <svg width={size} height={size} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="8" y1="52" x2="22" y2="52" stroke="#0F172A" strokeWidth="5" strokeLinecap="round" />
                <line x1="78" y1="52" x2="92" y2="52" stroke="#0F172A" strokeWidth="5" strokeLinecap="round" />
                <line x1="50" y1="86" x2="50" y2="96" stroke="#0F172A" strokeWidth="5" strokeLinecap="round" />
                <circle cx="8" cy="52" r="5" fill="#0F172A" />
                <circle cx="92" cy="52" r="5" fill="#0F172A" />
                <circle cx="50" cy="96" r="5" fill="#0F172A" />
                <path d="M50 12 C72 12 78 34 78 52 C78 74 68 88 50 88 C32 88 22 74 22 52 C22 34 28 12 50 12 Z" stroke="#0F172A" strokeWidth="5" fill="white" />
                <path d="M50 28 C62 28 64 40 64 52 C64 68 58 74 50 74 C42 74 36 68 36 52 C36 40 38 28 50 28 Z" fill="#F59E0B" />
                <ellipse cx="44" cy="40" rx="3" ry="5" transform="rotate(-30 44 40)" fill="white" fillOpacity="0.9" />
            </svg>
        );

        const Modal = ({ message, onClose, type = 'info' }) => { 
            if (!message) return null; 
            const Icon = type === 'error' ? X : CheckCircle;
            const colorClass = type === 'error' ? 'text-red-600' : 'text-green-600';
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-[60]">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all scale-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className={`text-lg font-bold flex items-center gap-2 ${colorClass}`}>
                                <Icon size={20}/>
                                {type === 'error' ? 'Error de Carga' : 'Notificación'}
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 transition-colors"><X size={20} /></button>
                        </div>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="text-right">
                            <button onClick={onClose} className="bg-slate-900 text-white rounded-lg py-2 px-6 hover:bg-slate-800 transition-colors font-medium text-sm">Aceptar</button>
                        </div>
                    </div>
                </div>
            ); 
        };

        const ChartModal = ({ chartConfig, onClose, metricConfig }) => {
            useEffect(() => {
                const handleKeyDown = (event) => { if (event.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [onClose]);

            if (!chartConfig) return null;
            const { type, title, data, dataKey, color, xAxisKey } = chartConfig; 
            const renderChart = () => {
                const currentXAxisKey = xAxisKey || 'date'; 
                const commonProps = { data, margin: { top: 20, right: 30, left: 20, bottom: 20 } };
                const ChartComponent = type === 'histogram' || type === 'bar' ? BarChart : LineChart;
                const DataComponent = type === 'histogram' || type === 'bar' ? Bar : Line;
                const chartDataKey = type === 'histogram' ? 'count' : dataKey;
                const chartDataName = type === 'histogram' ? 'Conteo de Frecuencia' : (metricConfig[dataKey]?.name || title);
                const chartDataUnit = type === 'histogram' ? 'piezas' : (metricConfig[dataKey]?.unit || '');

                return (
                    <ChartComponent {...commonProps}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                        <XAxis 
                            dataKey={currentXAxisKey} 
                            stroke="#64748b" 
                            tick={{fontSize: 12}} 
                            tickFormatter={currentXAxisKey === 'date' ? (val) => val.split('-').slice(1).join('/') : undefined}
                            angle={currentXAxisKey !== 'date' ? -45 : 0} 
                            textAnchor={currentXAxisKey !== 'date' ? 'end' : 'middle'}
                            height={currentXAxisKey !== 'date' ? 60 : 30}
                        />
                        <YAxis stroke="#64748b" domain={['auto', 'auto']} tickFormatter={(t) => t.toFixed(type === 'line' ? 1 : 0)} />
                        <Tooltip 
                            contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} 
                            formatter={(value) => [`${value.toFixed(type === 'line' ? 2 : 0)} ${chartDataUnit}`, chartDataName]}
                            labelFormatter={(label) => currentXAxisKey === 'rangeLabel' ? `Rango: ${label}` : label}
                        />
                        <Legend />
                        <DataComponent 
                            type={type === 'line' ? 'monotone' : undefined} 
                            dataKey={chartDataKey}
                            stroke={type === 'line' ? color : undefined} 
                            fill={type !== 'line' ? color : undefined}
                            strokeWidth={type === 'line' ? 3 : 0} 
                            dot={type === 'line' ? false : undefined} 
                            activeDot={type === 'line' ? { r: 8 } : undefined} 
                            name={chartDataName}
                            radius={type !== 'line' ? [4, 4, 0, 0] : undefined}
                        />
                    </ChartComponent>
                );
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-5xl h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{title}</h3>
                                <p className="text-sm text-gray-500">Vista detallada y ampliada</p>
                            </div>
                            <button onClick={onClose} className="bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition-colors"><X size={24} /></button>
                        </div>
                        <div className="flex-grow w-full h-full">
                             <ResponsiveContainer width="100%" height="100%">{renderChart()}</ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        const MetricCard = ({ title, value, data, dataKey, color, unit, icon: Icon, onZoom }) => {
            const trend = data.length >= 2 ? (data[data.length - 1][dataKey]) - (data[data.length - 2][dataKey]) : 0;
            const isPositive = trend >= 0;
            return (
                <div 
                    className="p-5 rounded-xl shadow-lg flex flex-col justify-between hover:shadow-xl transition-shadow relative overflow-hidden group text-white"
                    style={{ backgroundColor: color }}
                >
                    <div className="absolute top-0 right-0 p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onClick={onZoom} className="p-1.5 bg-white/20 text-white rounded-md hover:bg-white/40 backdrop-blur-sm"><ZoomIn size={16} /></button>
                    </div>
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 rounded-lg bg-white/20 backdrop-blur-sm"><Icon size={24} className="text-white" /></div>
                        <div className={`flex items-center text-xs font-semibold px-2 py-1 rounded-full bg-white/20 backdrop-blur-sm text-white`}>
                            {isPositive ? <ArrowUpRight size={14} className="mr-1"/> : <ArrowDownRight size={14} className="mr-1"/>}
                            {Math.abs(trend).toFixed(2)}%
                        </div>
                    </div>
                    <div>
                        <h3 className="text-sm font-medium text-blue-50/90">{title}</h3>
                        <p className="text-3xl font-bold mt-1">{value} <span className="text-sm font-normal text-blue-50/80">{unit}</span></p>
                    </div>
                    <div className="h-16 mt-4 -mx-2">
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={data}><Line type="monotone" dataKey={dataKey} stroke="#ffffff" strokeWidth={3} dot={false} /></LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        const CountCard = ({ title, value, icon: Icon, color }) => (
            <div 
                className="p-5 rounded-xl shadow-lg flex flex-col justify-center relative overflow-hidden group text-white"
                style={{ backgroundColor: color }}
            >
                <div className="flex justify-between items-center mb-4">
                    <div className="p-3 rounded-lg bg-white/20 backdrop-blur-sm"><Icon size={24} className="text-white" /></div>
                </div>
                <div>
                    <h3 className="text-sm font-medium text-blue-50/90">{title}</h3>
                    <p className="text-3xl font-bold mt-1">{value.toLocaleString()}</p>
                    <p className="text-xs text-blue-50/80 mt-1">Total de registros</p>
                </div>
            </div>
        );

        const SidebarItem = ({ icon: Icon, label, active, onClick }) => (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 mb-1 ${
                    active ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-800'
                }`}
            >
                <Icon size={20} /><span>{label}</span>
            </button>
        );

        const AreaChartWithGradient = ({ data, dataKey, color, unit, name }) => (
            <ComposedChart data={data} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                <defs>
                    <linearGradient id={`color${dataKey}`} x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor={color} stopOpacity={0.2}/>
                        <stop offset="95%" stopColor={color} stopOpacity={0}/>
                    </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                <XAxis dataKey="date" stroke="#94a3b8" tick={{fontSize: 10}} tickFormatter={(val) => val.split('-').slice(1).join('/')} tickLine={false} axisLine={false} dy={10} />
                <YAxis stroke="#94a3b8" tick={{fontSize: 10}} domain={['auto', 'auto']} tickLine={false} axisLine={false} />
                <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }} itemStyle={{ color: color }} />
                <Area type="monotone" dataKey={dataKey} stroke={color} fillOpacity={1} fill={`url(#color${dataKey})`} strokeWidth={2} name={name} unit={unit} />
            </ComposedChart>
        );

        const DashboardChart = ({ title, data, dataKey, color, chartId, onDownload, scriptsReady, onZoom, type = 'line', unit, metricConfig }) => {
            return (
                <div id={chartId} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <div><h3 className="text-lg font-bold text-slate-800">{title}</h3><p className="text-xs text-slate-400">Últimos datos registrados</p></div>
                        <div className="flex gap-2">
                            <button onClick={onZoom} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"><ZoomIn size={18} /></button>
                            <button onClick={() => onDownload(chartId, `${title.replace(/\s+/g, '-')}.pdf`)} disabled={!scriptsReady} className="p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors disabled:opacity-30"><Download size={18} /></button>
                        </div>
                    </div>
                    <div className="flex-grow min-h-[250px]">
                        <ResponsiveContainer width="100%" height="100%">
                            {type === 'line' ? (
                                <AreaChartWithGradient data={data} dataKey={dataKey} color={color} unit={unit || ''} name={metricConfig[dataKey]?.name} />
                            ) : (
                                <BarChart data={getHistogramData(data, dataKey)} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                    <XAxis dataKey="range" stroke="#94a3b8" tick={{fontSize: 10}} tickLine={false} axisLine={false} dy={10} />
                                    <YAxis stroke="#94a3b8" tick={{fontSize: 10}} tickLine={false} axisLine={false} />
                                    <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                    <Bar dataKey="count" fill={color} radius={[4, 4, 0, 0]} name="Frecuencia" />
                                </BarChart>
                            )}
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        const ChatMessage = ({ role, text, sources = [] }) => {
            const isModel = role === 'model';
            return (
                <div className={`flex mb-4 ${isModel ? 'justify-start' : 'justify-end'}`}>
                    <div className={`max-w-3xl px-4 py-3 rounded-xl shadow-md ${isModel ? 'bg-slate-100 text-slate-800 rounded-tl-none' : 'bg-blue-600 text-white rounded-tr-none'}`}>
                        <p className="whitespace-pre-wrap">{text}</p>
                        {isModel && sources.length > 0 && (
                            <div className="mt-2 pt-2 border-t border-slate-300 text-xs text-slate-500">
                                <p className="font-semibold mb-1">Fuentes:</p>
                                <ul className="list-disc pl-4 space-y-0.5">{sources.map((s, i) => <li key={i}><a href={s.uri} target="_blank" className="hover:text-blue-600 underline truncate block">{s.title || s.uri}</a></li>)}</ul>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ChatBox = ({ chatHistory, onSubmit, isThinking, filters, averages, metricConfig }) => {
            const [input, setInput] = useState('');
            const endOfMessagesRef = useRef(null);
            
            useEffect(() => { endOfMessagesRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory]);

            const dataContext = useMemo(() => {
                const avg = Object.keys(averages).map(key => `${metricConfig[key].name}: ${averages[key]} ${metricConfig[key].unit}`).join(', ');
                return `Filtros: Granja ${filters.selectedFarm}, ${filters.selectedShed}... Registros: ${filters.recordCount}. Promedios: ${avg}.`;
            }, [filters, averages, metricConfig]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (input.trim() === '' || isThinking) return;
                onSubmit(input, dataContext);
                setInput('');
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border border-slate-100 flex flex-col h-[calc(100vh-200px)] min-h-[500px]">
                    <div className="p-4 border-b border-slate-200 flex justify-between items-center"><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><MessageSquare size={20} className="text-blue-600"/> Asistente Avícola</h3></div>
                    <div className="flex-grow p-4 overflow-y-auto space-y-4">
                        {chatHistory.length === 0 ? <div className="flex flex-col items-center justify-center h-full text-slate-400 text-center"><Egg size={40} className="mb-2"/><p>Pregúntale al experto.</p></div> : chatHistory.map((msg, i) => <ChatMessage key={i} role={msg.role} text={msg.text} sources={msg.sources} />)}
                        {isThinking && <div className="flex justify-start mb-4"><div className="bg-slate-100 px-4 py-3 rounded-xl rounded-tl-none shadow-md text-slate-500 flex items-center text-sm"><Loader size={16} className="animate-spin mr-2"/>Pensando...</div></div>}
                        <div ref={endOfMessagesRef} />
                    </div>
                    <form onSubmit={handleSubmit} className="p-4 border-t border-slate-200"><div className="flex gap-2"><input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="Escribe tu pregunta..." className="flex-1 p-3 border border-slate-300 rounded-xl" disabled={isThinking} /><button type="submit" disabled={isThinking || input.trim() === ''} className="bg-blue-600 text-white p-3 rounded-xl disabled:bg-blue-300"><Send size={20} /></button></div></form>
                </div>
            );
        };

        const useScript = (url) => {
            const [status, setStatus] = useState(url ? 'loading' : 'idle');
            useEffect(() => {
                if (!url) { setStatus('idle'); return; }
                let script = document.querySelector(`script[src="${url}"]`);
                if (!script) {
                    script = document.createElement('script');
                    script.src = url; script.async = true;
                    script.onload = () => setStatus('ready');
                    script.onerror = () => setStatus('error');
                    document.body.appendChild(script);
                } else {
                    setStatus('ready');
                }
            }, [url]);
            return status;
        };

        const METRIC_CONFIG = {
            weight: { name: 'Peso Huevo', color: '#3b82f6', unit: 'g', icon: Egg },
            breakingStrength: { name: 'Resistencia', color: '#f97316', unit: 'kgf', icon: Activity },
            shellThickness: { name: 'Espesor', color: '#10b981', unit: 'mm', icon:  TrendingUp},
            yolkColor: { name: 'Color Yema', color: '#eab308', unit: 'Escala', icon: PieChart },
            haughUnits: { name: 'Unid. Haugh', color: '#a855f7', unit: 'HU', icon: BarChart2 },
        };

        const INITIAL_DATA = generateMockData();

        const App = () => {
            const jspdfStatus = useScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
            const html2canvasStatus = useScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
            const scriptsReady = jspdfStatus === 'ready' && html2canvasStatus === 'ready';

            const [dashboardData, setDashboardData] = useState(INITIAL_DATA);
            const [selectedFarm, setSelectedFarm] = useState('Todos');
            const [selectedShed, setSelectedShed] = useState('Todos');
            const [selectedAge, setSelectedAge] = useState('Todos');
            const [selectedBreed, setSelectedBreed] = useState('Todos');
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setDate(d.getDate() - 29); return d.toISOString().split('T')[0]; });
            const [fileName, setFileName] = useState('');
            const [modal, setModal] = useState({ show: false, message: '', type: 'info' });
            const [activeTab, setActiveTab] = useState('dashboard'); 
            const [isDownloading, setIsDownloading] = useState(false);
            const [zoomedChart, setZoomedChart] = useState(null);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [chatHistory, setChatHistory] = useState([]);
            const [isThinking, setIsThinking] = useState(false);

            const FARMS = useMemo(() => ['Todos', ...Array.from(new Set(dashboardData.map(d => d.farm).filter(Boolean)))], [dashboardData]);
            const SHEDS = useMemo(() => ['Todos', ...Array.from(new Set(dashboardData.map(d => d.shed).filter(Boolean)))], [dashboardData]);
            const AGES = useMemo(() => ['Todos', ...Array.from(new Set(dashboardData.map(d => d.age).filter(Boolean)))].sort((a, b) => { 
                if (a === 'Todos') return -1; if (b === 'Todos') return 1; return parseInt(a) - parseInt(b);
            }), [dashboardData]);
            const BREEDS = useMemo(() => ['Todos', ...Array.from(new Set(dashboardData.map(d => d.breed).filter(Boolean))).sort()], [dashboardData]);
            
            const filteredData = useMemo(() => {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); 
                return dashboardData.filter(d => {
                    const dDate = new Date(d.date);
                    return dDate >= start && dDate <= end &&
                        (selectedFarm === 'Todos' || d.farm === selectedFarm) &&
                        (selectedShed === 'Todos' || d.shed === selectedShed) &&
                        (selectedAge === 'Todos' || d.age === selectedAge) &&
                        (selectedBreed === 'Todos' || d.breed === selectedBreed);
                });
            }, [dashboardData, selectedFarm, selectedShed, selectedAge, selectedBreed, startDate, endDate]);

            const monthlyAverageData = useMemo(() => {
                const grouped = {};
                filteredData.forEach(d => {
                    const monthKey = d.date.substring(0, 7);
                    if (!grouped[monthKey]) {
                        grouped[monthKey] = { count: 0, dateLabel: monthKey.replace('-', '/') };
                        Object.keys(METRIC_CONFIG).forEach(key => grouped[monthKey][key] = 0);
                    }
                    grouped[monthKey].count++;
                    Object.keys(METRIC_CONFIG).forEach(key => { if (typeof d[key] === 'number') grouped[monthKey][key] += d[key]; });
                });
                return Object.keys(grouped).map(monthKey => {
                    const totalCount = grouped[monthKey].count;
                    const avg = { month: monthKey, dateLabel: grouped[monthKey].dateLabel };
                    Object.keys(METRIC_CONFIG).forEach(key => { avg[key] = totalCount > 0 ? parseFloat((grouped[monthKey][key] / totalCount).toFixed(2)) : 0; });
                    return avg;
                }).sort((a, b) => new Date(a.month).getTime() - new Date(b.month).getTime());
            }, [filteredData]);

            const globalAverages = useMemo(() => {
                const avg = {};
                Object.keys(METRIC_CONFIG).forEach(key => { avg[key] = calculateAllStats(filteredData, key).mean.toFixed(2); });
                return avg;
            }, [filteredData]);
            
            const handleChatSubmit = async (query, dataContext) => {
                setIsThinking(true);
                setChatHistory(prev => [...prev, { role: 'user', text: query, sources: [] }]);
                try {
                    const result = await sendMessageToGemini(query, dataContext);
                    setChatHistory(prev => [...prev, { role: 'model', text: result.text, sources: result.sources }]);
                } catch (error) {
                    setChatHistory(prev => [...prev, { role: 'model', text: "Error de conexión.", sources: [] }]);
                } finally {
                    setIsThinking(false);
                }
            };

            const handleFileChange = (event) => {
                // Simplified for brevity in this HTML version
                setModal({ show: true, message: "Funcionalidad de archivo simplificada en versión HTML.", type: 'info' });
            };

            const handleDownload = async (elementId, filename) => {
                if (!scriptsReady) { setModal({ show: true, message: "Librerías cargando...", type: 'info' }); return; }
                const element = document.getElementById(elementId);
                if (!element) return;
                setIsDownloading(true);
                try {
                    const canvas = await window.html2canvas(element, { backgroundColor: '#ffffff', scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const orientation = canvas.width > canvas.height ? 'landscape' : 'portrait';
                    const pdf = new jsPDF(orientation, 'px', [canvas.width, canvas.height]);
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(filename);
                } catch (error) {
                    console.error(error);
                    setModal({ show: true, message: "Error al generar PDF", type: 'error' });
                } finally {
                    setIsDownloading(false);
                }
            };

            const handleChartZoom = (type, key, title, data = filteredData, xAxisKey = 'date') => {
                 let chartData = data;
                 let chartXAxisKey = xAxisKey;
                 if (type === 'histogram' && data === filteredData) {
                      chartData = getHistogramData(data, key);
                      chartXAxisKey = 'rangeLabel';
                 }
                 setZoomedChart({ type, title: type === 'histogram' ? `Histograma ${title}` : title, data: chartData, dataKey: key, color: METRIC_CONFIG[key].color, xAxisKey: chartXAxisKey });
            };

            return (
                <div className="flex min-h-screen bg-slate-50 font-sans text-slate-800">
                    <aside className={`fixed inset-y-0 left-0 z-40 w-64 bg-white text-slate-700 transform transition-transform duration-300 ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 border-r border-slate-200`}>
                        <div className="p-6 flex items-center gap-3 border-b border-slate-200">
                            <EggMonitorLogo size={42} />
                            <div><h1 className="text-xl font-bold leading-none"><span className="text-cyan-600">Egg</span><span className="text-yellow-600">Monitor</span></h1><span className="text-xs text-slate-500">Quality Dashboard</span></div>
                        </div>
                        <nav className="p-4 space-y-2">
                            <p className="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Vistas</p>
                            <SidebarItem icon={Activity} label="Dashboard" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                            <SidebarItem icon={BarChart2} label="Histogramas" active={activeTab === 'histograms'} onClick={() => setActiveTab('histograms')} />
                            <SidebarItem icon={TrendingUp} label="Promedios Mensuales" active={activeTab === 'monthly-averages'} onClick={() => setActiveTab('monthly-averages')} /> 
                            <SidebarItem icon={FileText} label="Resumen Datos" active={activeTab === 'summary'} onClick={() => setActiveTab('summary')} />
                            <SidebarItem icon={MessageSquare} label="Asistente Avícola" active={activeTab === 'chat'} onClick={() => setActiveTab('chat')} />
                        </nav>
                        <div className="p-4 border-t border-slate-200">
                            <p className="px-4 text-xs font-semibold text-slate-700 uppercase tracking-wider mb-4">Filtros ({filteredData.length})</p>
                            <div className="space-y-4 px-2">
                                <div><label className="block text-xs mb-1 text-slate-700">Rango de Fechas</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full bg-slate-100 border border-slate-300 rounded text-xs p-2 mb-2" /><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full bg-slate-100 border border-slate-300 rounded text-xs p-2" /></div>
                                {['Granja', 'Caseta', 'Edad', 'Estirpe'].map((label, idx) => {
                                   const val = [selectedFarm, selectedShed, selectedAge, selectedBreed][idx];
                                   const setVal = [setSelectedFarm, setSelectedShed, setSelectedAge, setSelectedBreed][idx];
                                   const opts = [FARMS, SHEDS, AGES, BREEDS][idx];
                                   return <div key={label}><label className="block text-xs mb-1 text-slate-700">{label}</label><select value={val} onChange={e => setVal(e.target.value)} className="w-full bg-slate-100 border border-slate-300 rounded text-sm p-2">{opts.map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                                })}
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto h-screen relative">
                        <div className="md:hidden bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-30"><div className="flex items-center gap-2"><EggMonitorLogo size={32} /><span className="font-bold"><span className="text-cyan-600">Egg</span><span className="text-yellow-600">Monitor</span></span></div><button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="text-slate-600"><Menu size={24} /></button></div>
                        <div className="p-4 md:p-8 max-w-7xl mx-auto pb-20">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4"><div className="w-full"><h2 className="font-bold text-slate-800 mb-2 text-2xl">{activeTab === 'dashboard' ? 'Dashboard' : activeTab}</h2><p className="text-slate-500 text-sm">Datos del <span className="font-semibold">{new Date(startDate).toLocaleDateString()}</span> al <span className="font-semibold">{new Date(endDate).toLocaleDateString()}</span></p></div></div>
                            {activeTab === 'dashboard' && (
                                <div className="space-y-8 animate-in fade-in duration-500">
                                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                        <CountCard title="Piezas" value={filteredData.length} icon={Egg} color="#06b6d4" />
                                        {Object.keys(METRIC_CONFIG).map(key => <MetricCard key={key} title={METRIC_CONFIG[key].name} value={globalAverages[key]} data={filteredData} dataKey={key} color={METRIC_CONFIG[key].color} unit={METRIC_CONFIG[key].unit} icon={METRIC_CONFIG[key].icon} onZoom={() => handleChartZoom('line', key, METRIC_CONFIG[key].name)} />)}
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {Object.keys(METRIC_CONFIG).map((key) => <DashboardChart key={key} chartId={`chart-${key}`} title={`Evolución: ${METRIC_CONFIG[key].name}`} data={filteredData} dataKey={key} color={METRIC_CONFIG[key].color} onDownload={handleDownload} scriptsReady={scriptsReady} onZoom={() => handleChartZoom('line', key, METRIC_CONFIG[key].name)} metricConfig={METRIC_CONFIG} unit={METRIC_CONFIG[key].unit} />)}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'histograms' && <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in duration-500">{Object.keys(METRIC_CONFIG).map((key) => <DashboardChart key={key} type="histogram" chartId={`hist-${key}`} title={`Distribución: ${METRIC_CONFIG[key].name}`} data={filteredData} dataKey={key} color={METRIC_CONFIG[key].color} onDownload={handleDownload} scriptsReady={scriptsReady} onZoom={() => handleChartZoom('histogram', key, METRIC_CONFIG[key].name, filteredData, 'rangeLabel')} metricConfig={METRIC_CONFIG} />)}</div>}
                            {activeTab === 'monthly-averages' && <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in duration-500">{Object.keys(METRIC_CONFIG).map((key) => <div key={key} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-[350px]"><h3 className="font-bold text-lg mb-2">{METRIC_CONFIG[key].name}</h3><ResponsiveContainer width="100%" height="100%"><BarChart data={monthlyAverageData}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="dateLabel"/><YAxis/><Tooltip/><Bar dataKey={key} fill={METRIC_CONFIG[key].color} /></BarChart></ResponsiveContainer></div>)}</div>}
                            {activeTab === 'summary' && <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6 grid grid-cols-1 md:grid-cols-3 gap-6">{Object.keys(METRIC_CONFIG).map(key => { const stats = calculateAllStats(filteredData, key); return <div key={key} className="border p-4 rounded-xl"><h4 className="font-bold mb-2" style={{color: METRIC_CONFIG[key].color}}>{METRIC_CONFIG[key].name}</h4><p>Promedio: {stats.mean.toFixed(2)}</p><p>Min: {stats.min.toFixed(2)}</p><p>Max: {stats.max.toFixed(2)}</p></div>})}</div>}
                            {activeTab === 'chat' && <ChatBox chatHistory={chatHistory} onSubmit={handleChatSubmit} isThinking={isThinking} filters={{selectedFarm, selectedShed, selectedAge, selectedBreed, startDate, endDate, recordCount: filteredData.length}} averages={globalAverages} metricConfig={METRIC_CONFIG} />}
                        </div>
                    </main>
                    {modal.show && <Modal message={modal.message} type={modal.type} onClose={() => setModal({ ...modal, show: false })} />}
                    {zoomedChart && <ChartModal chartConfig={zoomedChart} onClose={() => setZoomedChart(null)} metricConfig={METRIC_CONFIG} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>